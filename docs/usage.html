<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usage Guide &mdash; microJAX  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Troubleshooting" href="troubleshooting.html" />
    <link rel="prev" title="Getting Started" href="getting_started.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> microJAX
            <img src="_static/microjax.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#common-setup">Common setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#point-source-magnification">Point-source magnification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-by-step">Step-by-step</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#finite-source-binary-lenses">Finite-source binary lenses</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-the-trajectory">1. Build the trajectory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#evaluate-the-magnification">2. Evaluate the magnification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fine-tuning-parameters">Fine-tuning parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#triple-lenses">Triple lenses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#autodiff-and-jit">Autodiff and <code class="docutils literal notranslate"><span class="pre">jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#trajectory-helpers">Trajectory helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#best-practices">Best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Internals &amp; Contribution</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts &amp; Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">microJAX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Usage Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="usage-guide">
<h1>Usage Guide<a class="headerlink" href="#usage-guide" title="Permalink to this heading"></a></h1>
<p>This chapter walks through the most common workflows in microJAX and explains
what each knob does.  The goal is to provide copy-and-pasteable snippets along
with the context required to adapt them to your own microlensing problem.</p>
<section id="common-setup">
<h2>Common setup<a class="headerlink" href="#common-setup" title="Permalink to this heading"></a></h2>
<p>Start every session by enabling 64-bit mode and importing the building blocks
you intend to use.  Keeping everything in one place makes it easier to reuse the
same configuration across notebooks or scripts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">microjax.point_source</span><span class="w"> </span><span class="kn">import</span> <span class="n">mag_point_source</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">microjax.inverse_ray.lightcurve</span><span class="w"> </span><span class="kn">import</span> <span class="n">mag_binary</span><span class="p">,</span> <span class="n">mag_triple</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># stabilises the polynomial solver</span>
</pre></div>
</div>
<p>The snippets below assume this cell has already been run.  If you restart your
Python session, rerun it before continuing.</p>
</section>
<section id="point-source-magnification">
<h2>Point-source magnification<a class="headerlink" href="#point-source-magnification" title="Permalink to this heading"></a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">mag_point_source</span></code> when the source can be treated as infinitesimally small
and you need fast magnifications for one to three lenses.</p>
<section id="step-by-step">
<h3>Step-by-step<a class="headerlink" href="#step-by-step" title="Permalink to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Assemble the complex source coordinates.  The real part is the x-position,
the imaginary part is the y-position in Einstein radii.</p></li>
<li><p>Specify the lens configuration via <code class="docutils literal notranslate"><span class="pre">nlenses</span></code> and the associated parameters.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">mag_point_source</span></code>; the function broadcasts across any leading axes of
<code class="docutils literal notranslate"><span class="pre">w</span></code> so batches are handled automatically.</p></li>
</ol>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
    <span class="mf">0.00</span> <span class="o">+</span> <span class="mf">0.10</span><span class="n">j</span><span class="p">,</span>
    <span class="mf">0.05</span> <span class="o">+</span> <span class="mf">0.05</span><span class="n">j</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">0.10</span> <span class="o">+</span> <span class="mf">0.02</span><span class="n">j</span><span class="p">,</span>
<span class="p">])</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">mag_point_source</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">nlenses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Magnification per sample:&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">nlenses=3</span></code> introduces a third body.  Provide the additional keywords <code class="docutils literal notranslate"><span class="pre">q3</span></code>
(mass ratio of lens 3 to lens 1), <code class="docutils literal notranslate"><span class="pre">r3</span></code> (distance between lens 1 and 3), and
<code class="docutils literal notranslate"><span class="pre">psi</span></code> (position angle of lens 3, in radians).  All other keyword arguments are
fully broadcastable and can be supplied as arrays if you want to sweep over a
grid of lens parameters.</p>
</section>
</section>
<section id="finite-source-binary-lenses">
<h2>Finite-source binary lenses<a class="headerlink" href="#finite-source-binary-lenses" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">mag_binary</span></code> computes finite-source light curves by combining a fast
hexadecapole approximation with full inverse-ray integrations when required.</p>
<section id="build-the-trajectory">
<h3>1. Build the trajectory<a class="headerlink" href="#build-the-trajectory" title="Permalink to this heading"></a></h3>
<p>The helper below constructs a standard rectilinear trajectory.  Feel free to
replace it with your own sampler if you need orbital motion or parallax.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tE</span> <span class="o">=</span> <span class="mf">40.0</span>                      <span class="c1"># Einstein time (days)</span>
<span class="n">u0</span> <span class="o">=</span> <span class="mf">0.05</span>                      <span class="c1"># impact parameter</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">60.0</span><span class="p">)</span>      <span class="c1"># trajectory angle in radians</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>                       <span class="c1"># time of closest approach</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.01</span>                     <span class="c1"># source radius in Einstein units</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tE</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tE</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="n">tE</span>
<span class="n">y1</span> <span class="o">=</span> <span class="o">-</span><span class="n">u0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span>  <span class="n">u0</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>   <span class="c1"># source trajectory</span>
</pre></div>
</div>
</section>
<section id="evaluate-the-magnification">
<h3>2. Evaluate the magnification<a class="headerlink" href="#evaluate-the-magnification" title="Permalink to this heading"></a></h3>
<p>Call <code class="docutils literal notranslate"><span class="pre">mag_binary</span></code> with the trajectory, source radius, and lens parameters.  To
start, stick with the defaults for the optional arguments and only adjust them
if you hit performance limits.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="mf">0.95</span>                       <span class="c1"># projected separation</span>
<span class="n">q</span> <span class="o">=</span> <span class="mf">5e-4</span>                       <span class="c1"># mass ratio (m2/m1)</span>

<span class="n">mags</span> <span class="o">=</span> <span class="n">mag_binary</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">mag_binary</span></code> returns magnifications aligned with the input trajectory.  If you
need fluxes, multiply by the intrinsic source flux and add blends or baselines
as appropriate.</p>
</section>
<section id="fine-tuning-parameters">
<h3>Fine-tuning parameters<a class="headerlink" href="#fine-tuning-parameters" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">r_resolution</span></code> / <code class="docutils literal notranslate"><span class="pre">th_resolution</span></code>
Set the number of grid divisions in the radial and angular directions for the
inverse-ray shooting method. Increasing these values improves the accuracy of
the magnification calculation, but also raises computational and memory costs
on GPUs. Users should adjust them according to their accuracy requirements
and hardware limits.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_FULL_CALLS</span></code>
Determines the maximum number of magnification points that are computed with
the image-centered ray-shooting (ICRS) method. It sets an upper limit on the
points that require finite-source calculations, with the remaining points
evaluated using the hexadecapole approximation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chunk_size</span></code>
Controls how many points are processed in parallel by the ICRS method via
<code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code>. A larger value can improve GPU utilization but may exceed
device memory, causing out-of-memory errors. Smaller values are safer but may
slow down the computation. Users should tune this parameter based on their
GPU capacity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Nlimb</span></code>
Sets the number of source limb points used to construct annular sectors on the
lens plane, where ray-shooting integrations are performed. In most cases,
users do not need to change this value. Adjust it only if catastrophic errors
appear in magnification calculations.</p></li>
</ul>
</section>
</section>
<section id="triple-lenses">
<h2>Triple lenses<a class="headerlink" href="#triple-lenses" title="Permalink to this heading"></a></h2>
<p>Triple-lens finite-source calculations are handled by <code class="docutils literal notranslate"><span class="pre">mag_triple</span></code>.  The
inputs mirror the binary API, but you must describe the third body explicitly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mags_triple</span> <span class="o">=</span> <span class="n">mag_triple</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.10</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                         <span class="n">q3</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span> <span class="n">r3</span><span class="o">=</span><span class="mf">0.60</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">210.0</span><span class="p">))</span>
</pre></div>
</div>
<p>Guidelines:</p>
<ul class="simple">
<li><p>Start with the same trajectory used for the binary case; only the lens system
changes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">psi</span></code> is measured counter-clockwise from the lens 1–2 axis.</p></li>
</ul>
</section>
<section id="autodiff-and-jit">
<h2>Autodiff and <code class="docutils literal notranslate"><span class="pre">jit</span></code><a class="headerlink" href="#autodiff-and-jit" title="Permalink to this heading"></a></h2>
<p>All magnification routines are differentiable.  Wrapping them in <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code>
gives you compiled performance, and <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code> / <code class="docutils literal notranslate"><span class="pre">jax.jacrev</span></code> provide
derivatives for inference.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">grad</span><span class="p">,</span> <span class="n">jacrev</span><span class="p">,</span> <span class="n">jit</span>

<span class="n">data_flux</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;example_lightcurve.npy&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">forward_model</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">mags</span> <span class="o">=</span> <span class="n">mag_binary</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mags</span>  <span class="c1"># replace with instrument model if needed</span>

<span class="n">forward_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">forward_model</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">neg_log_like</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">forward_jit</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">resid</span> <span class="o">=</span> <span class="n">model</span> <span class="o">-</span> <span class="n">data_flux</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">neg_log_like</span><span class="p">)(</span><span class="n">q</span><span class="p">)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">jacrev</span><span class="p">(</span><span class="n">forward_jit</span><span class="p">)(</span><span class="n">q</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">jacrev</span></code> is especially useful when fitting multiple parameters simultaneously
or when propagating uncertainties through a light-curve model.</p>
</section>
<section id="trajectory-helpers">
<h2>Trajectory helpers<a class="headerlink" href="#trajectory-helpers" title="Permalink to this heading"></a></h2>
<p>For trajectories beyond straight lines, the <code class="xref py py-mod docutils literal notranslate"><span class="pre">microjax.trajectory</span></code> package
provides composable pieces:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api/trajectory.html#module-microjax.trajectory.parallax" title="microjax.trajectory.parallax"><code class="xref py py-mod docutils literal notranslate"><span class="pre">microjax.trajectory.parallax</span></code></a> – annual parallax terms.</p></li>
</ul>
<p>These components return arrays compatible with the <code class="docutils literal notranslate"><span class="pre">w</span></code> input used above, so
you can drop them into <code class="docutils literal notranslate"><span class="pre">mag_binary</span></code> / <code class="docutils literal notranslate"><span class="pre">mag_triple</span></code> without further changes.</p>
</section>
<section id="best-practices">
<h2>Best practices<a class="headerlink" href="#best-practices" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Keep 64-bit mode enabled for production runs; it significantly improves the
stability of implicit differentiation through the polynomial solver.</p></li>
<li><p>Use <a class="reference internal" href="api/likelihood.html#module-microjax.likelihood" title="microjax.likelihood"><code class="xref py py-mod docutils literal notranslate"><span class="pre">microjax.likelihood</span></code></a> to marginalise nuisance flux parameters instead
of fitting them manually—this often reduces sampler autocorrelation.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="getting_started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="troubleshooting.html" class="btn btn-neutral float-right" title="Troubleshooting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Shota Miyazaki.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>